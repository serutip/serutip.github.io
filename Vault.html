<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seru’s Pokémon Vault</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

        :root {
            --bg: #f5f0e6;
            --panel: #fdfaf7;
            --card: #efe3d5;
            --accent: #6b4e31;
            --purple: #8b6f9e;
            --green: #5d8b4e;
            --text: #3c2f2f;
            --text-dim: #6b5747;
            --border: #d9c2a7;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            padding: 0.8rem;
            font-size: 0.95rem;
        }
        .container {
            max-width: 1920px;
            margin: 0 auto;
            background: var(--panel);
            border-radius: 24px;
            overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(107, 78, 49, 0.15);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 1.6rem);
        }
        header {
            background: linear-gradient(135deg, #8b6f47, #a67c52);
            padding: 1.8rem 2rem 1.6rem;
            text-align: center;
            color: #fff8f0;
        }
        h1 {
            font-size: clamp(2.4rem, 6vw, 5rem);
            font-weight: 900;
            letter-spacing: 6px;
            text-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }
        header h2 {
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 4px;
            margin-top: 0.5rem;
        }
        .summary {
            padding: 1.2rem 2rem;
            background: #f0e6d2;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            border-bottom: 1px solid var(--border);
        }
        .controls {
            padding: 1rem 2rem;
            background: #fdfaf7;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            justify-content: center;
        }
        input[type="text"] {
            padding: 0.7rem 1.2rem;
            background: white;
            border: 1.8px solid #d9c2a7;
            border-radius: 14px;
            font-size: 0.95rem;
            min-width: 200px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(107, 78, 49, 0.15);
        }
        #lookupBtn {
            padding: 0.7rem 2rem;
            background: linear-gradient(135deg, #8b6f9e, #a78bfa);
            color: white;
            border: none;
            border-radius: 14px;
            font-weight: 900;
            font-size: 0.95rem;
            cursor: pointer;
        }
        #altInfo {
            margin: 0 2rem 1rem;
            padding: 1rem;
            background: #f0e6d2;
            border: 1.8px solid #d9c2a7;
            border-radius: 16px;
            font-size: 0.95rem;
            line-height: 1.5;
            text-align: center;
        }
        .results {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .vault-card {
            background: var(--card);
            border-radius: 20px;
            border: 2px solid var(--border);
            overflow: hidden;
            transition: all 0.4s;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(107, 78, 49, 0.1);
            position: relative;
        }
        .vault-card:hover {
            transform: translateY(-12px) scale(1.03);
            border-color: var(--accent);
            box-shadow: 0 25px 50px rgba(107, 78, 49, 0.25);
        }
        .card-img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
        }
        .card-info {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }
        .card-title {
            font-size: 0.95rem;
            font-weight: 800;
            color: var(--accent);
        }
        .card-detail {
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
        }
        .label { color: var(--text-dim); font-weight: 600; font-size: 0.8rem; }
        .insured { color: var(--green); font-weight: 800; }
        .listing { color: var(--purple); font-weight: 800; }
        .grade-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(107, 78, 49, 0.9);
            color: #fff8f0;
            padding: 0.3rem 0.6rem;
            border-radius: 10px;
            font-weight: 900;
            font-size: 0.75rem;
        }
        .footer {
            padding: 1rem;
            text-align: center;
            background: #ede0d4;
            color: var(--text-dim);
            font-size: 0.85rem;
            border-top: 1px solid var(--border);
        }
        .alt { color: var(--purple); font-weight: 800; }
        .sale { color: var(--green); font-weight: 800; }

        /* Detail Panel */
        #detailPanel {
            position: fixed;
            top: 0;
            right: -420px;
            width: 420px;
            height: 100vh;
            background: var(--panel);
            border-left: 1px solid var(--border);
            box-shadow: -15px 0 40px rgba(0, 0, 0, 0.15);
            padding: 2.5rem 2rem;
            transition: right 0.4s ease;
            z-index: 100;
            overflow-y: auto;
        }
        #detailPanel.open { right: 0; }
        #detailClose {
            position: absolute;
            top: 1.2rem;
            right: 1.8rem;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-dim);
        }
        #detailImg { width: 100%; max-height: 300px; object-fit: contain; background: #fff; border-radius: 16px; margin-bottom: 1.5rem; }
        #detailPanel h3 { font-size: 1.4rem; font-weight: 900; color: var(--accent); margin-bottom: 1.5rem; }
        #detailPanel p { margin-bottom: 1rem; font-size: 1rem; line-height: 1.4; }
        #detailPanel .value { font-weight: 800; }
        #detailPanel button {
            width: 100%;
            padding: 1.1rem;
            margin-top: 1.5rem;
            border: none;
            border-radius: 16px;
            font-weight: 900;
            font-size: 1.05rem;
            cursor: pointer;
        }
        #ccBtn { background: var(--accent); color: #fff8f0; }
        #marketBtn { background: linear-gradient(135deg, #8b6f9e, #a78bfa); color: white; }
        #altResearchBtn { background: linear-gradient(135deg, #4a2c6d, #7b4ba8); color: white; }

        @media (max-width: 768px) {
            #detailPanel {
                width: 100%;
                height: 70vh;
                bottom: -70vh;
                top: auto;
                right: 0;
                transition: bottom 0.4s ease;
            }
            #detailPanel.open { bottom: 0; }
            .results { grid-template-columns: 1fr; }
            .controls { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SERU’S VAULT</h1>
            <h2>Collector Crypt | Magic Eden</h2>
        </header>
        <div class="summary" id="summary">
            Loading your collection...
        </div>
        <div class="controls">
            <input type="text" id="certInput" placeholder="Enter PSA Cert Number">
            <button id="lookupBtn">LOOKUP ALT</button>
        </div>
        <div id="altInfo">Enter a PSA cert number and click LOOKUP ALT to search its value.</div>
        <div class="results" id="results"></div>
        <div class="footer">Wallet: 21beBQJJNCAFYpb1UvgykE5Vgrjjgq1U6cZWVcQ4ea6x • December 17, 2025</div>
    </div>

    <!-- Detail Panel -->
    <div id="detailPanel">
        <span id="detailClose">×</span>
        <img id="detailImg" src="" alt="Card">
        <h3 id="detailTitle"></h3>
        <p><strong>Grade:</strong> <span id="detailGrade"></span></p>
        <p><strong>Insured Value:</strong> <span id="detailInsured" class="value insured"></span></p>
        <p><strong>Current Listing:</strong> <span id="detailListing" class="value listing"></span></p>
        <p><strong>ALT Value:</strong> <span id="detailAlt" class="value alt">Loading...</span></p>
        <p><strong>Suggested Sale (97%):</strong> <span id="detailSale" class="value sale">Loading...</span></p>
        <p><strong>NFT Address:</strong> <a id="detailNftLink" href="" target="_blank"></a></p>
        <button id="altResearchBtn">Alt Research Page</button>
        <button id="ccBtn">View on Collector Crypt</button>
        <button id="marketBtn">View MagicEden Listing</button>
        
    </div>

    <script>
        const WALLET = '21beBQJJNCAFYpb1UvgykE5Vgrjjgq1U6cZWVcQ4ea6x';
        const API_URL = `https://api.collectorcrypt.com/cards/${WALLET}/?page=1&step=96&cardType=Card&orderBy=dateDesc`;

        let cards = [];

        const results = document.getElementById('results');
        const summary = document.getElementById('summary');
        const altInfo = document.getElementById('altInfo');
        const certInput = document.getElementById('certInput');
        const lookupBtn = document.getElementById('lookupBtn');

        async function fetchWalletData() {
            const proxies = [
                'https://api.allorigins.win/raw?url=',
                'https://corsproxy.io/?',
                'https://api.codetabs.com/v1/proxy?quest=',
                'https://cors-anywhere.herokuapp.com/'
            ];

            for (const proxy of proxies) {
                try {
                    const url = proxy + encodeURIComponent(API_URL);
                    const response = await fetch(url, { signal: AbortSignal.timeout(10000) });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.filterNFtCard && data.filterNFtCard.length > 0) {
                            return data;
                        }
                    }
                } catch (e) {
                    console.log(`Proxy failed: ${proxy}`, e);
                    continue;
                }
            }
            throw new Error('All proxies failed');
        }

        function processCards(rawData) {
            let rawCards = rawData.filterNFtCard || [];
            if (rawCards.length === 0) {
                rawCards = [];
                summary.textContent = 'Live data unavailable – showing latest known collection (Dec 17, 2025)';
            }
            cards = rawCards.map(card => {
                const title = card.itemName.split(' PSA ')[0].trim();
                let grade = `${card.gradingCompany || 'PSA'} ${card.grade}`;
                if (card.Tagtonft && card.Tagtonft.some(t => t.tag?.name === 'Grail')) {
                    grade += ' • Grail Tag';
                }
                return {
                    title,
                    img: card.images?.front || '',
                    grade,
                    insured: `$${card.insuredValue || '0'}`,
                    listing: card.listing ? `${card.listing.price} ${card.listing.currency}` : 'Not listed',
                    location: (card.location || []).join(' • '),
                    nft: card.nftAddress || '',
                    cert: card.gradingID || '',
                    altValue: null,
                    assetId: null
                };
            });
        }

        function renderCards() {
            results.innerHTML = '';
            cards.forEach(card => {
                if (!card.img) return;
                const el = document.createElement('div');
                el.className = 'vault-card';
                el.innerHTML = `
                    <div style="position:relative;">
                        <img class="card-img" src="${card.img}" alt="${card.title}" onload="this.style.opacity=1" style="opacity:0;transition:opacity 0.5s;">
                        <div class="grade-badge">${card.grade.split(' ')[1]} ${card.grade.split(' ')[2] || ''}</div>
                    </div>
                    <div class="card-info">
                        <div class="card-title">${card.title}</div>
                        <div class="card-detail"><span class="label">Insured:</span> <span class="insured">${card.insured}</span></div>
                        <div class="card-detail"><span class="label">Listed:</span> <span class="listing">${card.listing}</span></div>
                    </div>
                `;
                el.onclick = () => showDetail(card);
                results.appendChild(el);
            });
            const totalInsured = cards.reduce((sum, c) => sum + parseFloat(c.insured.slice(1) || 0), 0);
            summary.textContent = summary.textContent || `${cards.length} Cards • Total Insured Value: $${totalInsured} • All PSA Graded • Tokenized on Solana`;
        }

        async function fetchAltValue(cert) {
            if (!cert || !/^\d{6,}$/.test(cert)) return { value: null, assetId: null };
            try {
                const certRes = await fetch("https://alt-platform-server.production.internal.onlyalt.com/graphql/Cert", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        operationName: "Cert",
                        variables: {certNumber: cert},
                        query: `query Cert($certNumber: String!) { cert(certNumber: $certNumber) { asset { id name } gradeNumber gradingCompany } }`
                    })
                });
                if (!certRes.ok) return { value: null, assetId: null };
                const certJson = await certRes.json();
                const certData = certJson?.data?.cert;
                if (!certData?.asset?.id) return { value: null, assetId: null };

                const assetId = certData.asset.id;
                const grade = certData.gradeNumber || "10";
                const company = certData.gradingCompany || "PSA";

                const valueRes = await fetch("https://alt-platform-server.production.internal.onlyalt.com/graphql/AssetDetails", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        operationName: "AssetDetails",
                        variables: {id: assetId, tsFilter: {gradeNumber: grade, gradingCompany: company}},
                        query: `query AssetDetails($id: ID!, $tsFilter: TimeSeriesFilter!) { asset(id: $id) { altValueInfo(tsFilter: $tsFilter) { currentAltValue } } }`
                    })
                });
                if (!valueRes.ok) return { value: null, assetId };
                const valueJson = await valueRes.json();
                const currentValue = valueJson?.data?.asset?.altValueInfo?.currentAltValue;
                return { value: currentValue ? parseFloat(currentValue) : null, assetId };
            } catch (e) {
                console.error(e);
                return { value: null, assetId: null };
            }
        }

        async function loadAltValues() {
            for (const card of cards) {
                if (card.cert) {
                    const result = await fetchAltValue(card.cert);
                    card.altValue = result.value;
                    card.assetId = result.assetId;
                }
            }
        }

        function showDetail(card) {
            document.getElementById('detailImg').src = card.img;
            document.getElementById('detailTitle').textContent = card.title;
            document.getElementById('detailGrade').textContent = card.grade;
            document.getElementById('detailInsured').textContent = card.insured;
            document.getElementById('detailListing').textContent = card.listing;
            const nftLink = document.getElementById('detailNftLink');
            nftLink.textContent = card.nft ? `${card.nft.slice(0,8)}...${card.nft.slice(-8)}` : 'N/A';
            nftLink.href = card.nft ? `https://solscan.io/token/${card.nft}` : '#';

            const detailAlt = document.getElementById('detailAlt');
            const detailSale = document.getElementById('detailSale');
            const altBtn = document.getElementById('altResearchBtn');

            if (card.altValue !== null && card.altValue > 0 && card.assetId) {
                detailAlt.textContent = `$${card.altValue.toFixed(2)}`;
                detailSale.textContent = `$${(card.altValue * 0.97).toFixed(1)}`;
                altBtn.style.display = 'block';
                altBtn.onclick = () => window.open(`https://app.alt.xyz/research/${card.assetId}`, '_blank');
            } else {
                detailAlt.textContent = 'Not found on ALT';
                detailSale.textContent = 'N/A';
                altBtn.style.display = 'none';
            }

            document.getElementById('ccBtn').onclick = () => window.open('https://collectorcrypt.com/assets/solana/' + card.nft, '_blank');
            document.getElementById('marketBtn').onclick = () => window.open('https://magiceden.io/item-details/' + card.nft, '_blank');

            document.getElementById('detailPanel').classList.add('open');
        }

        document.getElementById('detailClose').onclick = () => {
            document.getElementById('detailPanel').classList.remove('open');
        };

        lookupBtn.onclick = async () => {
            const cert = certInput.value.trim();
            if (!cert) return;
            altInfo.innerHTML = 'Looking up...';
            const result = await fetchAltValue(cert);
            if (result.value !== null) {
                const sale = (result.value * 0.97).toFixed(1);
                altInfo.innerHTML = `<strong>ALT Value: $${result.value.toFixed(2)}</strong><br><strong>Suggested Sale (97%): $${sale}</strong>`;
                if (result.assetId) {
                    altInfo.innerHTML += `<br><a href="https://app.alt.xyz/browse/${result.assetId}" target="_blank" style="color: var(--purple); font-weight: 800;">Open Alt Research Page →</a>`;
                }
            } else {
                altInfo.innerHTML = '<strong style="color:#a00">No ALT value found or error.</strong>';
            }
        };

        (async () => {
            try {
                const data = await fetchWalletData();
                processCards(data);
            } catch (e) {
                console.error('All live fetches failed', e);
                processCards({ filterNFtCard: [] });
            }
            renderCards();
            await loadAltValues();
            renderCards();
        })();
    </script>
</body>
</html>