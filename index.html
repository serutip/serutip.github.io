<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seru’s Sniper Sniper</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

        :root {
            --bg: #f5f0e6;
            --panel: #fdfaf7;
            --card: #efe3d5;
            --accent: #6b4e31;
            --purple: #8b6f9e;
            --green: #5d8b4e;
            --text: #3c2f2f;
            --text-dim: #6b5747;
            --border: #d9c2a7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            padding: 0.8rem;
            font-size: 0.88rem;
        }

        .container {
            max-width: 1920px;
            margin: 0 auto;
            background: var(--panel);
            border-radius: 24px;
            overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(107, 78, 49, 0.15);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 1.6rem);
        }

        header {
            background: linear-gradient(135deg, #8b6f47, #a67c52);
            padding: 1.4rem 2rem 1.2rem;
            text-align: center;
            color: #fff8f0;
            position: relative;
        }

        h1 {
            font-size: clamp(2.2rem, 5.5vw, 4.5rem);
            font-weight: 900;
            letter-spacing: 6px;
            text-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }

        header h2 {
            font-size: 0.95rem;
            font-weight: 700;
            letter-spacing: 4px;
            margin-top: 0.3rem;
        }

        header h3 {
            font-size: 0.85rem;
            margin-top: 0.3rem;
        }

        #lastUpdatedHeader {
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.5rem;
            background: rgba(255, 248, 240, 0.3);
            padding: 0.3rem 0.9rem;
            border-radius: 12px;
            display: inline-block;
        }

        .controls {
            padding: 0.9rem 1.8rem;
            background: #fdfaf7;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .left-controls,
        .right-controls {
            display: flex;
            gap: 0.9rem;
            align-items: center;
            flex-wrap: wrap;
        }

        input[type="text"] {
            padding: 0.65rem 1.2rem;
            background: white;
            border: 1.8px solid #d9c2a7;
            border-radius: 14px;
            font-size: 0.95rem;
            min-width: 240px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(107, 78, 49, 0.15);
        }

        .btn-group {
            display: flex;
            background: white;
            border-radius: 14px;
            padding: 5px;
            border: 1.8px solid #d9c2a7;
            gap: 5px;
        }

        .btn {
            padding: 0.55rem 1.1rem;
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-weight: 600;
            font-size: 0.85rem;
            border-radius: 10px;
            cursor: pointer;
        }

        .btn.active {
            background: var(--accent);
            color: #fff8f0;
            font-weight: 800;
        }

        #lookupBtn {
            padding: 0.65rem 2rem;
            background: linear-gradient(135deg, #8b6f9e, #a78bfa);
            color: white;
            border: none;
            border-radius: 14px;
            font-weight: 900;
            font-size: 0.95rem;
            cursor: pointer;
        }

        #altInfo {
            margin: 0.8rem 1.8rem;
            padding: 0.9rem 1.4rem;
            background: #f0e6d2;
            border: 1.8px solid #d9c2a7;
            border-radius: 16px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .results {
            flex: 1;
            overflow-y: auto;
            padding: 1.6rem;
            transition: margin-right 0.3s ease;
        }

        .results.shifted {
            margin-right: 320px;
        }

        .year-section {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 1.6rem;
            margin-bottom: 1.4rem;
        }

        .year-title {
            font-size: 1.3rem;
            font-weight: 900;
            color: var(--accent);
            writing-mode: vertical-rl;
            transform: rotate(180deg);
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }

        .card {
            height: 110px;
            padding: 1rem;
            background: var(--card);
            border-radius: 18px;
            border: 1.8px solid #d9c2a7;
            color: var(--text);
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 0.6rem;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .card:hover {
            transform: translateY(-6px) scale(1.04);
            border-color: var(--accent);
            box-shadow: 0 15px 35px rgba(107, 78, 49, 0.2);
        }

        .card-code {
            font-size: 1.1rem;
            font-weight: 900;
            color: var(--accent);
        }

        .card-variety {
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--text-dim);
            margin-top: -4px;
            opacity: 0.9;
        }

        .price-row {
            font-size: 0.9rem;
            font-weight: 700;
        }

        .label {
            color: var(--text-dim);
            font-size: 0.7rem;
        }

        .insured {
            color: var(--green);
        }

        .alt {
            color: var(--purple);
            font-weight: 900;
        }

        .ext-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--purple);
            color: white;
            font-size: 0.6rem;
            font-weight: 900;
            padding: 3px 8px;
            border-radius: 10px;
        }

        .footer {
            padding: 0.8rem;
            text-align: center;
            background: #ede0d4;
            color: var(--text-dim);
            font-size: 0.8rem;
            border-top: 1px solid var(--border);
        }

        .setup {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 3rem;
            background: var(--panel);
        }

        .setup h2 {
            font-size: 2.2rem;
            color: var(--accent);
            margin-bottom: 1rem;
            font-weight: 900;
        }

        .load-btn {
            padding: 1.2rem 3.5rem;
            background: var(--accent);
            color: #fff8f0;
            border: none;
            border-radius: 20px;
            font-size: 1.4rem;
            font-weight: 900;
            cursor: pointer;
            box-shadow: 0 12px 40px rgba(107, 78, 49, 0.4);
            transition: all 0.3s;
        }

        .load-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 50px rgba(107, 78, 49, 0.5);
        }

        /* Detail Panel */
        #detailPanel {
            position: fixed;
            top: 0;
            right: -320px;
            width: 320px;
            height: 100vh;
            background: var(--panel);
            border-left: 1px solid var(--border);
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.1);
            padding: 2rem 1.5rem;
            transition: right 0.3s ease;
            z-index: 100;
            overflow-y: auto;
        }

        #detailPanel.open {
            right: 0;
        }

        #detailPanel h3 {
            font-size: 1.2rem;
            font-weight: 900;
            color: var(--accent);
            margin-bottom: 1.5rem;
        }

        #detailPanel p {
            font-size: 0.95rem;
            margin-bottom: 0.8rem;
        }

        #detailPanel .value {
            font-weight: 800;
        }

        #detailPanel .insured {
            color: var(--green);
        }

        #detailPanel .alt {
            color: var(--purple);
        }

        #detailPanel button {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 14px;
            font-weight: 900;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 0.8rem;
        }

        #detailEbayBtn {
            background: var(--accent);
            color: #fff8f0;
        }

        #detailEbayBtn:hover {
            background: #8b6f47;
        }

        #detailAltBtn {
            background: linear-gradient(135deg, #8b6f9e, #a78bfa);
            color: white;
            display: none;
        }

        #detailAltBtn:hover {
            background: #7a5c8a;
        }

        #detailClose {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-dim);
        }

        #detailImageContainer {
            margin: 1.5rem 0;
            text-align: center;
            display: none;
        }

        #detailImage {
            max-width: 100%;
            max-height: 400px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        #hoverPreview {
            position: absolute;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            overflow: hidden;
            border: 3px solid white;
            max-width: 140px;
            transform: translate(15px, -50%);
        }

        #hoverPreview.show {
            opacity: 1;
        }

        #hoverPreview img {
            display: block;
            width: 100%;
            height: auto;
        }

        @media (max-width: 768px) {
            .results.shifted {
                margin-right: 0;
                margin-bottom: 320px;
            }

            #detailPanel {
                right: -100%;
                width: 100%;
                height: 320px;
                top: auto;
                bottom: 0;
                border-left: none;
                border-top: 1px solid var(--border);
            }

            #detailPanel.open {
                right: 0;
            }
        }

        .year-section+.year-section {
            margin-top: 2.8rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>ALT Dictionary</h1>
            <h2>V2.0 — COFFEE EDITION</h2>
            <h3>Seru</h3>
            <div id="lastUpdatedHeader">Loading...</div>
            <h6>Insured Value is only pulled once to make mint refreshs quicker</h6>
        </header>

        <div class="controls">
            <div class="left-controls">
                <input type="text" id="searchInput" placeholder="Search Pokémon or card name...">
                <div class="btn-group">
                    <button class="btn lang-en active" data-lang="en">EN</button>
                    <button class="btn lang-jp" data-lang="jp">JP</button>
                </div>
                <div class="btn-group">
                    <button class="btn grade-psa10 active" data-grade="10">PSA 10</button>
                    <button class="btn grade-psa9" data-grade="9">PSA 9</button>
                    <button class="btn grade-cgc10" data-grade="cgc">CGC 10</button>
                </div>
                <div class="btn-group">
                    <button id="externalToggle" class="btn active">+ EXTERNAL</button>
                </div>
            </div>
            <div class="right-controls">
                <button id="lookupBtn">LOOKUP ALT</button>
                <input type="text" id="certInput" placeholder="PSA Cert Number">
            </div>
        </div>

        <div id="altInfo">Enter a PSA cert number → click LOOKUP ALT</div>
        <div class="results" id="results"></div>
        <div class="footer">
            <div id="status">Initializing…</div>
        </div>
    </div>

    <!-- Detail Panel -->
    <div id="detailPanel">
        <span id="detailClose">×</span>
        <h3>Card Details</h3>
        <p><strong>Card Name:</strong> <span id="detailCardName"></span></p>
        <p><strong>Pokémon:</strong> <span id="detailName"></span></p>
        <p><strong>Year:</strong> <span id="detailYear"></span></p>
        <p><strong>Code:</strong> <span id="detailCode"></span></p>
        <p><strong>Variety:</strong> <span id="detailVariety"></span></p>
        <p><strong>Insured Value:</strong> <span id="detailInsured" class="value insured"></span></p>
        <p><strong>Alt Value:</strong> <span id="detailAlt" class="value alt"></span></p>
        <p id="detailLastUpdatedRow" style="display:none;"><strong>Last Updated:</strong> <span
                id="detailLastUpdated"></span></p>

        <div id="detailImageContainer">
            <img id="detailImage" src="" alt="Card Image">
        </div>

        <button id="detailEbayBtn">View Sold eBay Listings</button>
        <button id="detailAltBtn">View Alt Research Page</button>
    </div>

    <!-- Hover Preview -->
    <div id="hoverPreview"><img src="" alt="Preview"></div>

    <script>
        const data = { en: { psa10: {}, psa9: {}, cgc10: {}, external: {} }, jp: { psa10: {}, psa9: {}, cgc10: {}, external: {} } };
        let currentLang = 'en', currentGrade = '10', includeExternal = true;
        let currentData = {};
        const results = document.getElementById('results');
        const searchInput = document.getElementById('searchInput');
        const status = document.getElementById('status');
        const altInfo = document.getElementById('altInfo');

        const detailPanel = document.getElementById('detailPanel');
        const detailClose = document.getElementById('detailClose');
        const detailName = document.getElementById('detailName');
        const detailCardName = document.getElementById('detailCardName');
        const detailYear = document.getElementById('detailYear');
        const detailCode = document.getElementById('detailCode');
        const detailVariety = document.getElementById('detailVariety');
        const detailInsured = document.getElementById('detailInsured');
        const detailAlt = document.getElementById('detailAlt');
        const detailLastUpdated = document.getElementById('detailLastUpdated');
        const detailLastUpdatedRow = document.getElementById('detailLastUpdatedRow');
        const detailImageContainer = document.getElementById('detailImageContainer');
        const detailImage = document.getElementById('detailImage');
        const detailEbayBtn = document.getElementById('detailEbayBtn');
        const detailAltBtn = document.getElementById('detailAltBtn');

        const hoverPreview = document.getElementById('hoverPreview');
        const hoverImg = hoverPreview.querySelector('img');

        detailClose.onclick = () => { detailPanel.classList.remove('open'); results.classList.remove('shifted'); };
        document.addEventListener('click', e => {
            if (!detailPanel.contains(e.target) && !e.target.closest('.card')) {
                detailPanel.classList.remove('open');
                results.classList.remove('shifted');
            }
        });

        window.loadLocalFiles = function () {
            const input = document.createElement('input'); input.type = 'file'; input.multiple = true; input.accept = '.json';
            input.onchange = e => {
                const files = Array.from(e.target.files); let loaded = 0;
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        try {
                            const name = file.name.toLowerCase();
                            const isJP = name.includes('jp') || name.includes('_jp');
                            const lang = isJP ? 'jp' : 'en';
                            const isExternal = name.includes('external');
                            const json = JSON.parse(reader.result.replace(/^\uFEFF/, '').trim());
                            const grade = name.includes('psa10') ? 'psa10' : name.includes('psa9') ? 'psa9' : 'cgc10';
                            if (isExternal) {
                                if (!data[lang].external) data[lang].external = {};
                                data[lang].external[grade] = json;
                            } else data[lang][grade] = json;
                            if (++loaded === files.length) { updateData(); status.textContent = `Loaded ${files.length} files`; results.innerHTML = ''; }
                        } catch (err) { console.error(err); }
                    };
                    reader.readAsText(file);
                });
            };
            input.click();
        };

        async function tryAutoLoad() {
            if (location.protocol === 'file:') return false;
            const files = ['./Dicts/PSA10.json', './Dicts/PSA9.json', './Dicts/CGC10.json', './Dicts/PSA10_JP.json', './Dicts/PSA9_JP.json', './Dicts/CGC10_JP.json', './Dicts/PSA10_external.json', './Dicts/PSA10_JP_external.json', './Dicts/PSA9_external.json', './Dicts/PSA9_JP_external.json'];
            let loaded = 0;
            for (const f of files) {
                try {
                    const r = await fetch(f + '?t=' + Date.now(), { cache: 'no-store' });
                    if (!r.ok) continue;
                    const json = JSON.parse((await r.text()).replace(/^\uFEFF/, '').trim());
                    const isJP = f.includes('JP') || f.includes('_JP');
                    const lang = isJP ? 'jp' : 'en';
                    const isExternal = f.includes('_external');
                    const grade = f.includes('PSA10') ? 'psa10' : f.includes('PSA9') ? 'psa9' : 'cgc10';
                    if (isExternal) {
                        if (!data[lang].external) data[lang].external = {};
                        data[lang].external[grade] = json;
                    } else data[lang][grade] = json;
                    loaded++;
                } catch (e) { }
            }
            return loaded >= 6;
        }

        function buildCurrentData() {
            const key = currentGrade === '10' ? 'psa10' : currentGrade === '9' ? 'psa9' : 'cgc10';
            const base = structuredClone(data[currentLang][key] || {});

            if (!includeExternal || currentGrade === 'cgc') return base;

            const ext = data[currentLang].external?.[key];
            if (!ext) return base;

            if (includeExternal && currentGrade !== 'cgc' && ext) {
                for (const [poke, years] of Object.entries(ext)) {
                    if (!base[poke]) base[poke] = {};

                    for (const [yr, codes] of Object.entries(years)) {
                        if (!base[poke][yr]) base[poke][yr] = {};

                        for (const [code, varieties] of Object.entries(codes)) {
                            if (!base[poke][yr][code]) base[poke][yr][code] = {};

                            for (const [variety, val] of Object.entries(varieties)) {
                                const key = variety || 'STANDARD';

                                if (!base[poke][yr][code][key] ||
                                    (base[poke][yr][code][key].insured_value === 0 &&
                                        base[poke][yr][code][key].alt_value === 0)) {

                                    const altValue = val.alt_value ?? val.insured_value ?? 0;
                                    if (Number(altValue) === 0) continue;

                                    base[poke][yr][code][key] = {
                                        insured_value: val.insured_value ?? 0,
                                        alt_value: altValue,
                                        asset_id: val.asset_id || null,
                                        name: val.name || null,
                                        ImageURL: val.ImageURL || '',
                                        LastUpdated: val.LastUpdated || ''
                                    };
                                }
                            }
                        }
                    }
                }
            }
            return base;
        }

        function formatCardContent(code, variety, val, name, year, isExt = false) {
            const clean = code.replace(/^#/, '').replace('NA', '').trim();
            const varietyText = (variety && variety !== 'STANDARD') ? `<div class="card-variety">(${variety})</div>` : '';
            const badge = isExt ? '<div class="ext-badge">NON-CC</div>' : '';

            let priceLine = '';
            const insured = val?.insured_value ?? 0;
            const alt = val?.alt_value ?? 0;
            if (insured > 0) priceLine += `<div class="price-row"><span class="label">INSURED:</span> <span class="insured">$${Number(insured).toLocaleString()}</span></div>`;
            if (alt > 0) priceLine += `<div class="price-row"><span class="label">ALT:</span> <span class="alt">$${Number(alt).toFixed(2)}</span></div>`;

            return `
                <div class="card${isExt ? ' external' : ''}">
                    ${badge}
                    <div class="card-code">#${clean}</div>
                    ${varietyText}
                    ${priceLine}
                </div>`;
        }

        function getEbaySearchTerms(name, year, code, variety) {
            const parts = [name, year];
            const cleanCode = code.replace(/^#/, '').replace('NA', '').trim();
            if (!cleanCode.toLowerCase().includes('promo')) parts.push(cleanCode);
            if (variety && variety !== 'STANDARD') parts.push(variety);
            parts.push(currentGrade === '10' ? 'PSA 10' : currentGrade === '9' ? 'PSA 9' : 'CGC 10');
            if (currentLang === 'jp') parts.push('Japanese');
            return parts.filter(Boolean).join(' ');
        }

        function showDetailPanel(name, year, code, variety, insured, alt, assetId, cardName, imageUrl = '', lastUpdated = '') {
            detailName.textContent = name;
            detailYear.textContent = year;
            detailCode.textContent = code;
            detailVariety.textContent = variety || 'Standard';

            if (cardName && cardName.trim() !== '') {
                detailCardName.textContent = cardName.trim();
                detailCardName.parentElement.style.display = 'block';
            } else {
                detailCardName.parentElement.style.display = 'none';
            }

            detailInsured.textContent = insured > 0 ? `$${Number(insured).toLocaleString()}` : 'N/A';
            detailAlt.textContent = alt > 0 ? `$${Number(alt).toFixed(2)}` : 'N/A';

            if (lastUpdated && lastUpdated.trim() !== '') {
                detailLastUpdated.textContent = lastUpdated.trim();
                detailLastUpdatedRow.style.display = 'block';
            } else {
                detailLastUpdatedRow.style.display = 'none';
            }

            if (imageUrl && imageUrl.trim() !== '') {
                detailImage.src = imageUrl;
                detailImageContainer.style.display = 'block';
            } else {
                detailImage.src = '';
                detailImageContainer.style.display = 'none';
            }

            const terms = getEbaySearchTerms(name, year, code, variety);
            const ebayUrl = `https://www.ebay.com/sch/i.html?_nkw=${encodeURIComponent(terms)}&LH_Sold=1&LH_Complete=1`;
            detailEbayBtn.onclick = () => window.open(ebayUrl, '_blank');

            if (assetId) {
                detailAltBtn.style.display = 'block';
                detailAltBtn.onclick = () => window.open(`https://app.alt.xyz/research/${assetId}`, '_blank');
            } else {
                detailAltBtn.style.display = 'none';
            }

            detailPanel.classList.add('open');
            results.classList.add('shifted');
        }

        function updateData() { currentData = buildCurrentData(); search(); }

        function search() {
            const q = searchInput.value.trim();
            if (!q) {
                results.innerHTML = '';
                return;
            }

            const lowerQ = q.toLowerCase();
            const queryWords = lowerQ.split(/\s+/).filter(w => w.length > 0);

            // Extract filters
            let yearFilter = null;
            let codeFilter = null;
            let tempTokens = lowerQ.split(/\s+/);
            const lastToken = tempTokens[tempTokens.length - 1];
            if (/^\d{4}$/.test(lastToken) || ['151', 'sv1', 'sv2', 'sv3', 'sv4', 'sv5', 'sv6'].includes(lastToken)) {
                yearFilter = lastToken;
                tempTokens.pop();
            } else if (lastToken.startsWith('#')) {
                codeFilter = lastToken.slice(1);
                tempTokens.pop();
            }

            results.innerHTML = '';

            const matchingPokemon = new Set();

            // Scan for matches
            Object.keys(currentData).forEach(poke => {
                const pokeData = currentData[poke];
                if (!pokeData) return;

                let hasMatch = false;

                Object.entries(pokeData).forEach(([year, yearsData]) => {
                    if (yearFilter && year !== yearFilter) return;

                    Object.entries(yearsData).forEach(([code, codesData]) => {
                        const cleanCode = code.replace(/^#/, '').replace('NA', '').trim();
                        if (codeFilter && cleanCode !== codeFilter && cleanCode !== codeFilter.padStart(3, '0')) return;

                        Object.entries(codesData).forEach(([variety, varietiesData]) => {
                            Object.entries(varietiesData).forEach(([key, card]) => {
                                const cardNameLower = (card.name || '').toLowerCase();

                                // Primary: full query substring
                                if (cardNameLower.includes(lowerQ)) {
                                    hasMatch = true;
                                }
                                // Secondary: all words present
                                else if (queryWords.every(word => cardNameLower.includes(word))) {
                                    hasMatch = true;
                                }
                            });
                        });
                    });
                });

                if (hasMatch) matchingPokemon.add(poke);
            });

            // Fallback to Pokémon name
            if (matchingPokemon.size === 0) {
                Object.keys(currentData).forEach(poke => {
                    const pokeLower = poke.toLowerCase();
                    if (pokeLower.includes(lowerQ) || queryWords.every(word => pokeLower.includes(word))) {
                        matchingPokemon.add(poke);
                    }
                });
            }

            // Display
            Array.from(matchingPokemon).sort().slice(0, 40).forEach(name => {
                const pokeData = currentData[name];
                if (!pokeData) return;

                const yearsToCheck = yearFilter
                    ? (pokeData[yearFilter] ? [[yearFilter, pokeData[yearFilter]]] : [])
                    : Object.entries(pokeData).sort(([a], [b]) => a.localeCompare(b));

                const container = document.createElement('div');
                container.innerHTML = `<div style="font-size:1.2rem;font-weight:800;color:var(--accent);margin-bottom:0.8rem">${name.toUpperCase()}</div>`;

                let hasAnyCard = false;

                yearsToCheck.forEach(([year, codes]) => {
                    const sec = document.createElement('div');
                    sec.className = 'year-section';
                    sec.innerHTML = `<div class="year-title">${year}</div><div class="cards"></div>`;
                    const cardsContainer = sec.querySelector('.cards');

                    Object.entries(codes).forEach(([code, varieties]) => {
                        const cleanCode = code.replace(/^#/, '').replace('NA', '').trim();
                        if (codeFilter && cleanCode !== codeFilter && cleanCode !== codeFilter.padStart(3, '0')) return;

                        Object.entries(varieties).forEach(([variety, val]) => {
                            const cardObj = currentData[name][year][code][variety || 'STANDARD'];
                            const cardNameLower = (cardObj?.name || '').toLowerCase();
                            const pokeLower = name.toLowerCase();

                            const matchesFull = cardNameLower.includes(lowerQ);
                            const matchesWords = queryWords.every(word => cardNameLower.includes(word));
                            const matchesPoke = pokeLower.includes(lowerQ) || queryWords.every(word => pokeLower.includes(word));

                            if (matchesFull || matchesWords || matchesPoke) {
                                const isExt = val.insured_value === 0;
                                const cardEl = document.createElement('div');
                                cardEl.innerHTML = formatCardContent(code, variety, val, name, year, isExt);
                                const cardDiv = cardEl.querySelector('.card');

                                const imageUrl = cardObj?.ImageURL || '';
                                const lastUpdated = cardObj?.LastUpdated || '';
                                const cardName = cardObj?.name || '';

                                cardDiv.onclick = () => {
                                    showDetailPanel(name, year, code, variety || 'Standard', parseFloat(val.insured_value) || 0, parseFloat(val.alt_value) || 0, val.asset_id || null, cardName, imageUrl, lastUpdated);
                                };

                                if (imageUrl && imageUrl.trim() !== '') {
                                    cardDiv.onmouseenter = () => {
                                        hoverImg.src = imageUrl;
                                        hoverPreview.classList.add('show');
                                    };
                                    cardDiv.onmousemove = (e) => {
                                        hoverPreview.style.top = e.clientY + 'px';
                                        hoverPreview.style.left = e.clientX + 'px';
                                    };
                                    cardDiv.onmouseleave = () => {
                                        hoverPreview.classList.remove('show');
                                        setTimeout(() => {
                                            if (!hoverPreview.classList.contains('show')) hoverImg.src = '';
                                        }, 300);
                                    };
                                }

                                cardsContainer.appendChild(cardEl);
                                hasAnyCard = true;
                            }
                        });
                    });

                    if (cardsContainer.children.length > 0) {
                        container.appendChild(sec);
                    }
                });

                if (hasAnyCard) {
                    results.appendChild(container);
                }
            });
        }

        searchInput.addEventListener('input', search);
        document.querySelectorAll('[data-lang]').forEach(b => b.onclick = () => {
            document.querySelectorAll('[data-lang]').forEach(x => x.classList.remove('active'));
            b.classList.add('active'); currentLang = b.dataset.lang; updateData();
        });
        document.querySelectorAll('[data-grade]').forEach(b => b.onclick = () => {
            document.querySelectorAll('[data-grade]').forEach(x => x.classList.remove('active'));
            b.classList.add('active'); currentGrade = b.dataset.grade; updateData();
        });
        document.getElementById('externalToggle').onclick = () => {
            includeExternal = !includeExternal;
            this.classList.toggle('active');
            this.textContent = includeExternal ? '+ EXTERNAL' : 'EXTERNAL OFF';
            updateData();
        };

        document.getElementById('lookupBtn').onclick = async () => {
            const cert = document.getElementById('certInput').value.trim();
            if (!/^\d{6,}$/.test(cert)) {
                altInfo.innerHTML = '<strong style="color:#a00">Invalid cert number (6+ digits)</strong>';
                return;
            }

            altInfo.innerHTML = 'Looking up cert...';

            try {
                // Step 1: Get Asset ID from cert
                const certRes = await fetch("https://alt-platform-server.production.internal.onlyalt.com/graphql/Cert", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        operationName: "Cert",
                        variables: { certNumber: cert },
                        query: `
                    query Cert($certNumber: String!) {
                        cert(certNumber: $certNumber) {
                            asset { id name }
                            gradeNumber
                            gradingCompany
                        }
                    }
                `
                    })
                });

                const certJson = await certRes.json();
                const certData = certJson?.data?.cert;
                if (!certData?.asset?.id) throw new Error("Cert not found on Alt");

                const assetId = certData.asset.id;
                const cardName = certData.asset.name || "Unknown Card";
                const grade = certData.gradeNumber;
                const company = certData.gradingCompany;

                // Step 2: Get Alt Value
                const valueRes = await fetch("https://alt-platform-server.production.internal.onlyalt.com/graphql/AssetDetails", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        operationName: "AssetDetails",
                        variables: {
                            id: assetId,
                            tsFilter: {
                                gradeNumber: grade || "10.0",
                                gradingCompany: company || "PSA"
                            }
                        },
                        query: `
                    query AssetDetails($id: ID!, $tsFilter: TimeSeriesFilter!) {
                        asset(id: $id) {
                            altValueInfo(tsFilter: $tsFilter) {
                                currentAltValue
                                confidenceData {
                                    currentErrorLowerBound
                                    currentErrorUpperBound
                                }
                            }
                        }
                    }
                `
                    })
                });

                const valueJson = await valueRes.json();
                const info = valueJson?.data?.asset?.altValueInfo;
                if (!info?.currentAltValue) throw new Error("No Alt value available");

                const val = Number(info.currentAltValue).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const low = info.confidenceData?.currentErrorLowerBound ? Math.round(info.confidenceData.currentErrorLowerBound) : "N/A";
                const high = info.confidenceData?.currentErrorUpperBound ? Math.round(info.confidenceData.currentErrorUpperBound) : "N/A";

                // Asset ID is now a clickable link!
                altInfo.innerHTML = `
            <strong>Asset ID (Click for research page):</strong> 
            <a href="https://app.alt.xyz/research/${assetId}" target="_blank" style="color:#8b6f9e; font-weight:900; text-decoration:underline;">
                ${assetId}
            </a><br><br>
            <strong style="font-size:1.15em; color:#6b4e31;">${cardName} ${company} ${grade}</strong><br><br>
            <strong>Alt Value: $${val}</strong><br>
            <strong>70% Range: $${low} – $${high}</strong>
        `;

            } catch (e) {
                altInfo.innerHTML = `<strong style="color:#a00">Error:</strong> ${e.message}`;
            }
        };

        (async () => {
            if (location.protocol === 'file:') {
                results.innerHTML = `<div class="setup"><h2>Local Mode Active</h2><p>Click below to load your dictionary files</p><button class="load-btn" onclick="loadLocalFiles()">LOAD JSON FILES</button></div>`;
                status.textContent = 'Local — click to load';
                return;
            }
            const success = await tryAutoLoad();
            if (success) { updateData(); status.textContent = 'Ready'; }
            else {
                results.innerHTML = `<div class="setup"><h2>Offline</h2><p>Load dictionary files manually</p><button class="load-btn" onclick="loadLocalFiles()">LOAD JSON FILES</button></div>`;
                status.textContent = 'Offline — load manually';
            }
        })();

        fetch('./Dicts/LastUpdated.txt?' + Date.now())
            .then(r => r.ok ? r.text() : 'Unknown')
            .then(t => document.getElementById('lastUpdatedHeader').textContent = t.trim() || 'Last updated: Unknown')
            .catch(() => { });
    </script>
</body>

</html>