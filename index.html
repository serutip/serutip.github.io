<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PSA 9 · PSA 10 · CGC 10 | EN + JP + Homework</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; margin: 0; padding: 2rem; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; text-align: center; }
        .header h1 { margin: 0; font-size: 2rem; }
        .search-box { padding: 2rem; border-bottom: 1px solid #eee; display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
        #searchInput { flex: 1; min-width: 280px; padding: 1rem 1.5rem; font-size: 1.1rem; border: 2px solid #ddd; border-radius: 50px; outline: none; }
        #searchInput:focus { border-color: #667eea; box-shadow: 0 0 0 4px rgba(102,126,234,0.1); }
        .toggle-group { display: flex; background: #f1f3f5; border-radius: 50px; padding: 4px; gap: 4px; }
        .toggle-btn { padding: 0.7rem 1.2rem; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; min-width: 80px; }
        .toggle-btn.active { color: white; }
        .grade-psa10.active { background: #28a745; }
        .grade-psa9.active  { background: #dc3545; }
        .grade-cgc10.active { background: #1a73e8; }
        .lang-en.active  { background: #007bff; }
        .lang-jp.active  { background: #d32f2f; }
        .results { max-height: 650px; overflow-y: auto; }
        .item { padding: 1.5rem 2rem; border-bottom: 1px solid #f0f0f0; }
        .item:hover { background: #f8f9ff; }
        .no-results { text-align: center; padding: 3rem; color: #888; font-style: italic; }
        .highlight { background: #fff3cd; padding: 0.1em 0.2em; border-radius: 3px; }
        .name { font-weight: bold; font-size: 1.2rem; margin-bottom: 0.5rem; }
        .year-title { font-weight: 600; color: #333; margin: 0.8rem 0 0.4rem; }
        .card-list { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .card {
            background: #e8f4fd; padding: 0.3rem 0.6rem; border-radius: 6px;
            font-size: 0.85rem; font-family: monospace; text-decoration: none; color: inherit;
            display: inline-block; transition: all 0.2s; position: relative;
        }
        .card:hover { background: #d0e8ff; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card-value { color: #007bff; font-weight: bold; }
        .card-value::after { content: " (PSA 10)"; font-size: 0.65rem; color: #28a745; font-weight: bold; margin-left: 4px; }
        body.psa9  .card-value::after { content: " (PSA 9)";  color: #dc3545; }
        body.cgc10 .card-value::after { content: " (CGC 10)"; color: #1a73e8; }
        body.jp    .card-value::after { content: " (JP)"; color: #d32f2f; font-size: 0.6rem; }
        .homework-badge {
            background: #ff9800; color: white; font-size: 0.55rem; padding: 2px 6px; border-radius: 4px;
            margin-left: 6px; font-weight: bold; vertical-align: middle;
        }
        .footer { text-align: center; padding: 1rem; background: #f9f9f9; border-top: 1px solid #eee; color: #666; font-size: 0.9rem; }
        .last-updated { background: #e3f2fd; color: #1565c0; padding: 0.8rem; border-radius: 8px; font-weight: 600; margin-top: 1rem; font-size: 1rem; }
        .setup { text-align: center; padding: 4rem 2rem; }
        .setup button { padding: 16px 32px; background: #667eea; color: white; border: none; border-radius: 12px; font-size: 1.2rem; cursor: pointer; }
    }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PSA 9 · PSA 10 · CGC 10 | EN + JP + Homework</h1>
            <p>Click any card → eBay sold listings | <span style="color:#ffeb3b;">Homework</span> = not from Collector Crypt · $1 = hidden (not updated yet)</p>
        </div>

        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Type name (e.g. Mew) or name + year (e.g. Mew 2024)" autocomplete="off" />

            <div class="toggle-group">
                <button class="toggle-btn lang-en active" data-lang="en">EN</button>
                <button class="toggle-btn lang-jp" data-lang="jp">JP</button>
            </div>

            <div class="toggle-group">
                <button class="toggle-btn grade-psa10 active" data-grade="10">PSA 10</button>
                <button class="toggle-btn grade-psa9" data-grade="9">PSA 9</button>
                <button class="toggle-btn grade-cgc10" data-grade="cgc">CGC 10</button>
            </div>
        </div>

        <div class="results" id="results"></div>
        
        <div class="footer">
            <div id="status">Loading data...</div>
            <div id="lastUpdated" class="last-updated" style="display:none;"></div>
        </div>
    </div>

    <script>
        const data = { en: { psa10: {}, psa9: {}, cgc10: {} }, jp: { psa10: {}, psa9: {}, cgc10: {} } };
        let homeworkData = {}; // Raw homework.json (may contain $1 placeholders)
        let currentLang = 'en', currentGrade = '10', currentData = {};
        let nameQuery = '';
        let latestTimestamp = 0;
        let filesLoaded = 0;

        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');
        const searchInput = document.getElementById('searchInput');
        const lastUpdatedDiv = document.getElementById('lastUpdated');

        const FILES = {
            en: { '10': 'PSA10_clean.json', '9': 'PSA9.json', 'cgc': 'CGC10.json' },
            jp: { '10': 'PSA10_JP.json', '9': 'PSA9_JP.json', 'cgc': 'CGC10_JP.json' }
        };

        // === AUTO LOAD ===
        async function tryAutoLoad() {
            filesLoaded = 0;
            latestTimestamp = 0;

            for (const lang of ['en', 'jp']) {
                for (const [g, file] of Object.entries(FILES[lang])) {
                    try {
                        const r = await fetch(file + '?t=' + Date.now(), { cache: 'no-store' });
                        if (r.ok) {
                            const text = (await r.text()).replace(/^\uFEFF/, '').trim();
                            const key = g === '10' ? 'psa10' : g === '9' ? 'psa9' : 'cgc10';
                            data[lang][key] = JSON.parse(text);
                            filesLoaded++;

                            const lastMod = r.headers.get('last-modified');
                            if (lastMod) latestTimestamp = Math.max(latestTimestamp, new Date(lastMod).getTime());
                        }
                    } catch (e) {}
                }
            }

            // Load homework.json
            try {
                const r = await fetch('homework.json?t=' + Date.now());
                if (r.ok) {
                    const text = (await r.text()).replace(/^\uFEFF/, '').trim();
                    homeworkData = JSON.parse(text);
                    filesLoaded++;

                    const lastMod = r.headers.get('last-modified');
                    if (lastMod) latestTimestamp = Math.max(latestTimestamp, new Date(lastMod).getTime());
                }
            } catch (e) {}

            return filesLoaded >= 6;
        }

        // === MANUAL LOAD (local) ===
        window.pickFiles = () => {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = '.json'; input.multiple = true;
            input.onchange = e => {
                const files = Array.from(e.target.files);
                filesLoaded = 0;
                latestTimestamp = Date.now();

                files.forEach(f => {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        try {
                            const json = JSON.parse(ev.target.result.replace(/^\uFEFF/, '').trim());
                            const n = f.name.toLowerCase();

                            if (n.includes('homework')) {
                                homeworkData = json;
                            } else if (n.includes('jp')) {
                                if (n.includes('psa10')) data.jp.psa10 = json;
                                else if (n.includes('psa9')) data.jp.psa9 = json;
                                else if (n.includes('cgc10')) data.jp.cgc10 = json;
                            } else {
                                if (n.includes('psa10') || n.includes('clean')) data.en.psa10 = json;
                                else if (n.includes('psa9')) data.en.psa9 = json;
                                else if (n.includes('cgc10')) data.en.cgc10 = json;
                            }
                            filesLoaded++;
                            if (f.lastModified > latestTimestamp) latestTimestamp = f.lastModified;

                            if (filesLoaded >= 6) {
                                updateData();
                                showLastUpdated();
                                statusDiv.textContent = 'All files loaded';
                            }
                        } catch (err) { console.error(err); }
                    };
                    reader.readAsText(f);
                });
            };
            input.click();
        };

        function showManualLoad() {
            resultsDiv.innerHTML = `<div class="setup"><h3>Opening locally?</h3><p>Select your JSON files (including homework.json if you have it)</p><button onclick="pickFiles()">Load Files</button></div>`;
            statusDiv.textContent = 'Local loading';
        }

        function showLastUpdated() {
            const date = new Date(latestTimestamp);
            const formatted = date.toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            lastUpdatedDiv.textContent = `Last updated: ${formatted}`;
            lastUpdatedDiv.style.display = 'block';
        }

        // === MERGE DATA (filter out $1 from homework) ===
        function buildCurrentData() {
            const key = currentGrade === '10' ? 'psa10' : currentGrade === '9' ? 'psa9' : 'cgc10';
            const baseData = data[currentLang][key] || {};

            // Deep clone + merge homework (but skip any card with value === 1)
            const merged = JSON.parse(JSON.stringify(baseData)); // deep copy

            if (currentLang === 'en' && currentGrade === '10' && Object.keys(homeworkData).length) {
                for (const [name, years] of Object.entries(homeworkData)) {
                    if (!merged[name]) merged[name] = {};
                    for (const [year, cards] of Object.entries(years)) {
                        if (!merged[name][year]) merged[name][year] = {};
                        for (const [code, price] of Object.entries(cards)) {
                            if (price !== 1) { // ← HIDE $1 placeholders
                                merged[name][year][code] = price;
                            }
                        }
                    }
                }
            }

            return merged;
        }

        function updateData() {
            currentData = buildCurrentData();

            document.body.className = currentLang === 'jp' ? 'jp' : '';
            if (currentGrade === '9') document.body.classList.add('psa9');
            if (currentGrade === 'cgc') document.body.classList.add('cgc10');
            search();
        }

        function formatCard(code, value, name, year, isHomework = false) {
            const clean = code.replace(/^#/, '').trim();
            const lang = currentLang === 'jp' ? 'Japanese' : '';
            const terms = [name, year, clean, getGradeText(), lang].filter(Boolean).join(' ');
            const url = `https://www.ebay.com/sch/i.html?_nkw=${encodeURIComponent(terms)}&LH_Sold=1&LH_Complete=1`;
            const badge = isHomework ? '<span class="homework-badge">Homework</span>' : '';
            return `<a href="${url}" target="_blank" class="card">${code}: <span class="card-value">$${value}</span>${badge}<span style="margin-left:4px;font-size:0.7rem;opacity:0.7;color:#0064d5;">eBay</span></a>`;
        }

        function renderPokemon(name, path) {
            let html = `<div class="name">${highlight(name)}</div>`;
            Object.keys(path).sort().reverse().forEach(year => { // newest years first
                const cards = path[year];
                let cardHtml = '';
                Object.keys(cards).forEach(code => {
                    const isHomework = homeworkData[name]?.[year]?.[code] !== undefined;
                    cardHtml += formatCard(code, cards[code], name, year, isHomework);
                });
                if (cardHtml) html += `<div class="year-section"><div class="year-title">${year}</div><div class="card-list">${cardHtml}</div></div>`;
            });
            return html;
        }

        function renderYearOnly(name, year, cards) {
            let html = `<div class="name">${highlight(name)} - ${year}</div><div class="card-list">`;
            Object.keys(cards).forEach(code => {
                const isHomework = homeworkData[name]?.[year]?.[code] !== undefined;
                html += formatCard(code, cards[code], name, year, isHomework);
            });
            return html + '</div>';
        }

        function search() {
            const query = searchInput.value.trim();
            resultsDiv.innerHTML = '';
            if (!query) { resultsDiv.innerHTML = '<div class="no-results">Start typing...</div>'; nameQuery = ''; return; }
            if (Object.keys(currentData).length === 0) { resultsDiv.innerHTML = '<div class="no-results">Loading...</div>'; return; }

            const parts = query.toLowerCase().split(/\s+/).filter(p => p);
            nameQuery = parts[0];
            const yearQuery = parts.length > 1 ? parts.slice(1).join(' ') : '';

            const matches = Object.keys(currentData)
                .filter(name => name.toLowerCase().includes(nameQuery))
                .slice(0, 20);

            if (!matches.length) { resultsDiv.innerHTML = '<div class="no-results">No Pokémon found</div>'; return; }

            matches.forEach(name => {
                const path = currentData[name];
                const div = document.createElement('div');
                div.className = 'item';
                if (yearQuery && path[yearQuery]) {
                    div.innerHTML = renderYearOnly(name, yearQuery, path[yearQuery]);
                } else {
                    div.innerHTML = renderPokemon(name, path);
                }
                resultsDiv.appendChild(div);
            });
        }

        function highlight(text) {
            if (!nameQuery) return text;
            const regex = new RegExp(`(${nameQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function getGradeText() {
            return currentGrade === '10' ? 'PSA 10' : currentGrade === '9' ? 'PSA 9' : 'CGC 10';
        }

        // Event listeners
        searchInput.addEventListener('input', search);
        document.querySelectorAll('[data-lang]').forEach(b => b.onclick = () => {
            document.querySelectorAll('[data-lang]').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
            currentLang = b.dataset.lang;
            updateData();
        });
        document.querySelectorAll('[data-grade]').forEach(b => b.onclick = () => {
            document.querySelectorAll('[data-grade]').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
            currentGrade = b.dataset.grade;
            updateData();
        });

        // Startup
        (async () => {
            const success = await tryAutoLoad();
            if (success) {
                updateData();
                showLastUpdated();
                statusDiv.textContent = 'Ready – $1 homework cards hidden';
            } else {
                showManualLoad();
            }
        })();
    </script>
</body>
</html>
